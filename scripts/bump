#!/usr/bin/env bash
set -e

# Check arguments
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <major|minor|patch>"
    exit 1
fi

# Check if on main branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "Error: Must be on main branch to bump version"
    exit 1
fi

# Check for clean working directory
if [ -n "$(git status --porcelain)" ]; then
    echo "Error: Working directory is not clean"
    exit 1
fi

# Pull latest main branch
git pull origin main

# Bump version
rye version bump "$1"
NEW_VERSION=$(rye version)

# Commit changes and create tag
git add pyproject.toml
git commit -m "chore: bump version to ${NEW_VERSION}"
git tag "v${NEW_VERSION}"

# Push changes
git push origin main "v${NEW_VERSION}"

echo "âœ¨ Version ${NEW_VERSION} has been released!"
echo "GitHub Actions will now create a release and publish to PyPI"
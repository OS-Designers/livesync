#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

PROTOBUFS_DIR="protobufs"
PROTO_FILE="${PROTOBUFS_DIR}/remote_node.proto"
OUTPUT_DIR="src/livesync/prebuilt/nodes/remote_node/server"

echo "==> Compiling proto files"

# Compile specific proto file
if [ -f "$PROTO_FILE" ]; then
    base_name="remote_node"
    output_dir="${OUTPUT_DIR}"
    
    echo "    Compiling: ${base_name}.proto"
    mkdir -p "$output_dir"
    touch "${output_dir}/__init__.py"
    
    python -m grpc_tools.protoc \
        -I"$PROTOBUFS_DIR" \
        --python_out="$output_dir" \
        --grpc_python_out="$output_dir" \
        --mypy_out="$output_dir" \
        "$PROTO_FILE" || {
            echo -e "${RED}Failed to compile: ${base_name}.proto${NC}"
            exit 1
        }

    # Modify imports to be relative
    sed -i '' 's/^import \([^_][^_].*\)_pb2/from . import \1_pb2/' "${output_dir}/${base_name}_pb2.py"
    sed -i '' 's/^import \([^_][^_].*\)_pb2/from . import \1_pb2/' "${output_dir}/${base_name}_pb2_grpc.py"

    echo -e "${GREEN}Proto compilation completed successfully!${NC}"
else
    echo -e "${RED}Error: remote_node.proto not found in ${PROTOBUFS_DIR}${NC}"
    exit 1
fi